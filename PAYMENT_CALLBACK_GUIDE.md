# æ”¯ä»˜å›è°ƒåŠŸèƒ½ä½¿ç”¨æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®ç°äº†å®Œæ•´çš„æ”¯ä»˜å›è°ƒå¤„ç†åŠŸèƒ½ã€‚å½“ç”¨æˆ·ä» NOWPayments æ”¯ä»˜é¡µé¢å®Œæˆæ”¯ä»˜å¹¶é‡å®šå‘å›ç½‘ç«™æ—¶ï¼Œå‰ç«¯ä¼šè‡ªåŠ¨ï¼š

1. è§£æ URL ä¸­çš„ `orderId` å‚æ•°
2. è°ƒç”¨åç«¯ API æŸ¥è¯¢è®¢å•çŠ¶æ€
3. æ ¹æ®è®¢å•çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„ UI
4. è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·æ˜Ÿæ˜Ÿä½™é¢

---

## å®ç°çš„åŠŸèƒ½

### 1. æ–°å¢ API æ¥å£

**æ–‡ä»¶**: `services/api/payments.ts`

```typescript
/**
 * æ ¹æ® orderId æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
 * ç”¨äºæ”¯ä»˜å›è°ƒé¡µé¢æŸ¥è¯¢è®¢å•çŠ¶æ€
 */
export async function getPaymentStatusByOrder(orderId: string): Promise<PaymentStatusResponse>
```

### 2. æ”¯ä»˜å›è°ƒç»„ä»¶

**æ–‡ä»¶**: `components/PaymentCallback.tsx`

åŠŸèƒ½ç‰¹æ€§ï¼š
- âœ… è‡ªåŠ¨è§£æ URL å‚æ•° (`payment` å’Œ `orderId`)
- âœ… æŸ¥è¯¢è®¢å•çŠ¶æ€
- âœ… æ™ºèƒ½è½®è¯¢æœºåˆ¶ï¼ˆæœ€å¤š 24 æ¬¡ï¼Œæ¯ 5 ç§’ä¸€æ¬¡ï¼‰
- âœ… å¤šç§çŠ¶æ€æ˜¾ç¤ºï¼š
  - ğŸ”„ **Loading**: æ­£åœ¨æŸ¥è¯¢è®¢å•çŠ¶æ€
  - â³ **Waiting**: æ”¯ä»˜æ­£åœ¨ç¡®è®¤ä¸­ï¼ˆåŒºå—é“¾äº¤æ˜“ç¡®è®¤ï¼‰
  - âœ… **Success**: æ”¯ä»˜æˆåŠŸï¼Œæ˜Ÿæ˜Ÿå·²å……å€¼
  - âŒ **Error**: æ”¯ä»˜å¤±è´¥/å–æ¶ˆ/è¿‡æœŸ
- âœ… è‡ªåŠ¨åˆ·æ–°æ˜Ÿæ˜Ÿä½™é¢
- âœ… ç²¾ç¾çš„ UI è®¾è®¡

### 3. App.tsx é›†æˆ

**æ–‡ä»¶**: `App.tsx`

é›†æˆå†…å®¹ï¼š
- âœ… å¯¼å…¥ `PaymentCallback` ç»„ä»¶
- âœ… æ·»åŠ  `showPaymentCallback` çŠ¶æ€
- âœ… URL å‚æ•°æ£€æµ‹é€»è¾‘
- âœ… æ”¯ä»˜å®Œæˆå›è°ƒå‡½æ•°
- âœ… æ¡ä»¶æ¸²æŸ“æ”¯ä»˜å›è°ƒé¡µé¢

---

## URL å‚æ•°æ ¼å¼

### æˆåŠŸå›è°ƒ URL

```
https://app.astromoon.xyz?payment=success&orderId=astro_123_1234567890
```

### å–æ¶ˆå›è°ƒ URL

```
https://app.astromoon.xyz?payment=cancelled&orderId=astro_123_1234567890
```

---

## æ”¯ä»˜æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"è´­ä¹°æ˜Ÿæ˜Ÿ"
    â†“
é€‰æ‹©å¥—é¤å’Œæ”¯ä»˜æ–¹å¼
    â†“
è°ƒç”¨ createPayment() API
    â†“
è·³è½¬åˆ° NOWPayments æ”¯ä»˜é¡µé¢
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
NOWPayments é‡å®šå‘å›ç½‘ç«™
    URL: ?payment=success&orderId=xxx
    â†“
å‰ç«¯æ£€æµ‹ URL å‚æ•°
    â†“
æ˜¾ç¤º PaymentCallback ç»„ä»¶
    â†“
è°ƒç”¨ getPaymentStatusByOrder(orderId)
    â†“
æ ¹æ®è®¢å•çŠ¶æ€æ˜¾ç¤º UI
    â†“
å¦‚æœæ˜¯ waiting/confirming â†’ å¼€å§‹è½®è¯¢
    â†“
çŠ¶æ€å˜ä¸º finished â†’ æ˜¾ç¤ºæˆåŠŸ
    â†“
åˆ·æ–°æ˜Ÿæ˜Ÿä½™é¢
    â†“
ç”¨æˆ·ç‚¹å‡»"è¿”å›é¦–é¡µ"
    â†“
æ¸…é™¤ URL å‚æ•°ï¼Œå›åˆ°ä¸»é¡µ
```

---

## è®¢å•çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç† |
|------|------|---------|
| `waiting` | ç­‰å¾…æ”¯ä»˜ | æ˜¾ç¤ºç­‰å¾… UIï¼Œå¼€å§‹è½®è¯¢ |
| `confirming` | æ”¯ä»˜ç¡®è®¤ä¸­ | æ˜¾ç¤ºç­‰å¾… UIï¼Œç»§ç»­è½®è¯¢ |
| `confirmed` | å·²ç¡®è®¤ | é€šå¸¸ä¼šå¿«é€Ÿå˜ä¸º `finished` |
| `finished` | æ”¯ä»˜å®Œæˆ | æ˜¾ç¤ºæˆåŠŸ UIï¼Œåˆ·æ–°ä½™é¢ |
| `failed` | æ”¯ä»˜å¤±è´¥ | æ˜¾ç¤ºå¤±è´¥ UI |
| `expired` | æ”¯ä»˜è¿‡æœŸ | æ˜¾ç¤ºè¿‡æœŸ UI |

---

## æµ‹è¯•æ–¹æ³•

### æ–¹æ³• 1: æ‰‹åŠ¨æµ‹è¯• URL

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   ```bash
   npm run dev
   ```

2. ç™»å½•ç³»ç»Ÿ

3. åœ¨æµè§ˆå™¨åœ°å€æ è®¿é—®ï¼š
   ```
   http://localhost:5173/?payment=success&orderId=test_order_123
   ```

4. è§‚å¯Ÿé¡µé¢æ˜¯å¦æ˜¾ç¤ºæ”¯ä»˜å›è°ƒç»„ä»¶

### æ–¹æ³• 2: å®Œæ•´æ”¯ä»˜æµç¨‹æµ‹è¯•

1. ç™»å½•ç³»ç»Ÿ
2. ç‚¹å‡»"è´­ä¹°æ˜Ÿæ˜Ÿ"
3. é€‰æ‹©å¥—é¤å’Œæ”¯ä»˜æ–¹å¼
4. åˆ›å»ºæ”¯ä»˜è®¢å•
5. åœ¨ NOWPayments é¡µé¢å®Œæˆæ”¯ä»˜ï¼ˆæˆ–å–æ¶ˆï¼‰
6. è§‚å¯Ÿé‡å®šå‘å›æ¥åçš„é¡µé¢æ˜¾ç¤º

### æ–¹æ³• 3: æ¨¡æ‹Ÿä¸åŒçŠ¶æ€

ä¿®æ”¹åç«¯æ¥å£è¿”å›ä¸åŒçš„è®¢å•çŠ¶æ€ï¼Œæµ‹è¯•å‰ç«¯ UIï¼š

- `status: 'waiting'` â†’ åº”æ˜¾ç¤ºç­‰å¾… UI å¹¶å¼€å§‹è½®è¯¢
- `status: 'finished'` â†’ åº”æ˜¾ç¤ºæˆåŠŸ UI å¹¶åˆ·æ–°ä½™é¢
- `status: 'failed'` â†’ åº”æ˜¾ç¤ºå¤±è´¥ UI
- `status: 'expired'` â†’ åº”æ˜¾ç¤ºè¿‡æœŸ UI

---

## è½®è¯¢æœºåˆ¶

### é…ç½®å‚æ•°

```typescript
const maxAttempts = 24;      // æœ€å¤šè½®è¯¢ 24 æ¬¡
const pollInterval = 5000;   // æ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡
// æ€»è®¡æœ€é•¿ç­‰å¾…æ—¶é—´: 24 Ã— 5s = 2 åˆ†é’Ÿ
```

### è½®è¯¢è§¦å‘æ¡ä»¶

å½“è®¢å•çŠ¶æ€ä¸ºä»¥ä¸‹ä»»ä¸€çŠ¶æ€æ—¶ï¼Œä¼šè§¦å‘è½®è¯¢ï¼š
- `waiting`
- `confirming`

### è½®è¯¢åœæ­¢æ¡ä»¶

è½®è¯¢ä¼šåœ¨ä»¥ä¸‹æƒ…å†µåœæ­¢ï¼š
1. çŠ¶æ€å˜ä¸º `finished` â†’ æ˜¾ç¤ºæˆåŠŸ
2. çŠ¶æ€å˜ä¸º `failed` â†’ æ˜¾ç¤ºå¤±è´¥
3. çŠ¶æ€å˜ä¸º `expired` â†’ æ˜¾ç¤ºè¿‡æœŸ
4. è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•° â†’ æ˜¾ç¤ºè¶…æ—¶æç¤º

---

## å…³é”®ä»£ç ç‰‡æ®µ

### App.tsx - URL æ£€æµ‹

```typescript
// æ£€æµ‹æ”¯ä»˜å›è°ƒ URL å‚æ•°
useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const paymentStatus = urlParams.get('payment');
  const orderId = urlParams.get('orderId');

  if (paymentStatus && orderId) {
    setShowPaymentCallback(true);
  }
}, []);
```

### PaymentCallback.tsx - è½®è¯¢é€»è¾‘

```typescript
const startPolling = (orderId: string) => {
  let attempts = 0;
  const maxAttempts = 24;
  const pollInterval = 5000;

  const intervalId = setInterval(async () => {
    attempts++;
    setCountdown(maxAttempts - attempts);

    if (attempts >= maxAttempts) {
      clearInterval(intervalId);
      setStatus('error');
      setError('è®¢å•ç¡®è®¤è¶…æ—¶ï¼Œè¯·ç¨ååœ¨è®¢å•å†å²ä¸­æŸ¥çœ‹');
      return;
    }

    try {
      const response = await getPaymentStatusByOrder(orderId);
      const invoiceData = response.invoice;

      if (invoiceData.status === 'finished') {
        clearInterval(intervalId);
        setStatus('success');
        await refreshStarBalance();
      }
    } catch (err) {
      console.error('è½®è¯¢è®¢å•çŠ¶æ€å¤±è´¥:', err);
    }
  }, pollInterval);
};
```

---

## åç«¯è¦æ±‚

åç«¯éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š

```
GET /api/payments/status-by-order/:orderId
```

### è¯·æ±‚å¤´

```
Authorization: Bearer <firebase-id-token>
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "invoice": {
    "id": 123,
    "user_id": 456,
    "invoice_id": "ABC123",
    "order_id": "astro_123_1234567890",
    "invoice_url": "https://nowpayments.io/payment/...",
    "product_type": "stars_30",
    "stars_amount": 30,
    "price_amount": 12.00,
    "pay_currency": "btc",
    "paid_amount": 12.00,
    "status": "finished",
    "created_at": "2025-01-04T10:00:00Z",
    "updated_at": "2025-01-04T10:05:00Z"
  }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: æ”¯ä»˜å®Œæˆåä½™é¢æ²¡æœ‰æ›´æ–°æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. åç«¯ Webhook æ˜¯å¦æ­£å¸¸æ¥æ”¶å¹¶å¤„ç†äº†æ”¯ä»˜é€šçŸ¥
2. æ•°æ®åº“ä¸­è®¢å•çŠ¶æ€æ˜¯å¦å·²æ›´æ–°ä¸º `finished`
3. å‰ç«¯æ˜¯å¦æˆåŠŸè°ƒç”¨äº† `getStarBalance()` API
4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### Q2: è½®è¯¢ä¸€ç›´ä¸åœæ­¢æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. åç«¯è®¢å•çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°
2. API å“åº”æ ¼å¼æ˜¯å¦æ­£ç¡®
3. è½®è¯¢æ¬¡æ•°æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆåº”è‡ªåŠ¨åœæ­¢ï¼‰

### Q3: é¡µé¢åˆ·æ–°åå›è°ƒä¿¡æ¯ä¸¢å¤±

**A**: è¿™æ˜¯æ­£å¸¸è¡Œä¸ºã€‚URL å‚æ•°ä»…åœ¨é¦–æ¬¡åŠ è½½æ—¶è¯»å–ã€‚å¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œå¯ä»¥ï¼š
1. å°†æ”¯ä»˜ç»“æœå­˜å‚¨åˆ° localStorage
2. æˆ–åœ¨åç«¯åˆ›å»ºé€šçŸ¥è®°å½•ä¾›æŸ¥è¯¢

### Q4: å¦‚ä½•æµ‹è¯•ä¸åŒçš„æ”¯ä»˜çŠ¶æ€ï¼Ÿ

**A**: å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š
1. ä¿®æ”¹åç«¯æ¥å£è¿”å›çš„ mock æ•°æ®
2. ä½¿ç”¨ NOWPayments çš„æµ‹è¯•æ¨¡å¼ï¼ˆsandboxï¼‰
3. æ‰‹åŠ¨åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹è®¢å•çŠ¶æ€

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. âœ… **Token éªŒè¯**: æ‰€æœ‰ API è¯·æ±‚éƒ½éœ€è¦ Firebase ID Token è®¤è¯
2. âœ… **è®¢å•å½’å±éªŒè¯**: åç«¯éœ€éªŒè¯è®¢å•æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
3. âœ… **é˜²æ­¢é‡å¤å……å€¼**: åç«¯åº”ç¡®ä¿åŒä¸€è®¢å•åªèƒ½æˆåŠŸå……å€¼ä¸€æ¬¡
4. âœ… **ç­¾åéªŒè¯**: Webhook éœ€éªŒè¯ NOWPayments ç­¾å

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ è®¢å•å†å²é¡µé¢**: ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ”¯ä»˜è®°å½•
2. **æ”¯ä»˜å¤±è´¥é‡è¯•**: å…è®¸ç”¨æˆ·é‡æ–°å°è¯•å¤±è´¥çš„æ”¯ä»˜
3. **æ¨é€é€šçŸ¥**: æ”¯ä»˜å®Œæˆæ—¶é€šè¿‡æµè§ˆå™¨é€šçŸ¥ç”¨æˆ·
4. **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒè‹±æ–‡ç­‰å…¶ä»–è¯­è¨€
5. **æ”¯ä»˜æ¸ é“é€‰æ‹©**: æ”¯æŒæ›´å¤šæ”¯ä»˜æ–¹å¼ï¼ˆå¦‚ä¿¡ç”¨å¡ï¼‰

---

## ç›¸å…³æ–‡ä»¶

- `services/api/payments.ts` - æ”¯ä»˜ API æ¥å£
- `services/api/types.ts` - ç±»å‹å®šä¹‰
- `services/api/index.ts` - API å¯¼å‡º
- `components/PaymentCallback.tsx` - æ”¯ä»˜å›è°ƒç»„ä»¶
- `App.tsx` - ä¸»åº”ç”¨ç»„ä»¶

---

## æŠ€æœ¯æ ˆ

- **React** 19.2.3
- **TypeScript** 5.6.2
- **Tailwind CSS** (æ ·å¼)
- **lucide-react** (å›¾æ ‡)
- **Firebase Auth** (è®¤è¯)

---

**æ›´æ–°æ—¥æœŸ**: 2026-01-04
**ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Claude Code
